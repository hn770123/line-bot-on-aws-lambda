# LINE Bot AWS デプロイ手順書

この手順書は、AWS Lambda を使用して LINE Bot を構築・デプロイするためのステップバイステップガイドです。

## 目次

1. [AWS アカウントの作成と初期設定](#1-aws-アカウントの作成と初期設定)
2. [コスト管理 (AWS Budgets)](#2-コスト管理-aws-budgets)
3. [データベースの準備 (DynamoDB)](#3-データベースの準備-dynamodb)
4. [Lambda 関数の作成と設定](#4-lambda-関数の作成と設定)
5. [デプロイ手順](#5-デプロイ手順)
6. [LINE Developers コンソールとの連携](#6-line-developers-コンソールとの連携)

---

## 1. AWS アカウントの作成と初期設定

### 1.1 AWS アカウントの作成
まだ AWS アカウントをお持ちでない場合は、[AWS 公式サイト](https://aws.amazon.com/jp/) から「AWS アカウントを今すぐ無料で作成」をクリックし、画面の指示に従って登録を行ってください。

### 1.2 ルートユーザーの MFA (多要素認証) 設定
セキュリティ強化のため、作成したルートユーザーに必ず MFA を設定してください。
1. AWS コンソールにルートユーザーでログインします。
2. 右上のアカウント名をクリックし、「セキュリティ認証情報」を選択します。
3. 「MFA (多要素認証)」セクションで「MFA デバイスの割り当て」をクリックし、スマートフォンアプリ (Google Authenticator など) を使用して設定します。

### 1.3 作業用 IAM ユーザーの作成
ルートユーザーは日常的な作業には使用せず、権限を絞った IAM ユーザーを作成して使用します。
1. サービス検索で「IAM」を検索し、IAM ダッシュボードへ移動します。
2. 左メニューの「ユーザー」→「ユーザーの作成」をクリックします。
3. ユーザー名を入力し、「AWS マネジメントコンソールへのユーザーアクセスを提供する」にチェックを入れます。
4. 「IAM ユーザーを作成します」を選択し、パスワードを設定します。
5. 「許可のオプション」で「ポリシーを直接アタッチする」を選択し、開発に必要な権限 (例: `AdministratorAccess` や、Lambda/DynamoDB へのアクセス権限) を付与します。
6. 作成後、ログイン URL、ユーザー名、パスワードを安全に保管します。

---

## 2. コスト管理 (AWS Budgets)

予期せぬ高額請求を防ぐため、予算アラートを設定します。

1. 右上のアカウントメニューから「マイ請求ダッシュボード」を選択、またはサービス検索で「AWS Budgets」を検索します。
2. 「予算を作成」をクリックします。
3. 「テンプレートを使用 (簡素化)」を選択し、「ゼロスペンド予算」または「月次コスト予算」を選択します。
4. 予算額 (例: $10) を入力し、通知先のメールアドレスを設定します。
5. 「予算を作成」をクリックして完了です。

---

## 3. データベースの準備 (DynamoDB)

LINE Bot の状態管理やデータ保存に使用する DynamoDB テーブルを作成します。

1. サービス検索で「DynamoDB」を検索し、ダッシュボードへ移動します。
2. 「テーブルの作成」をクリックします。
3. **テーブル名**: 任意の名前 (例: `LineBotTable`) を入力します。
4. **パーティションキー**: データの主キーとなる項目名 (例: `userId` (文字列)) を入力します。
5. **テーブル設定**: 「設定のカスタマイズ」を選択します。
   - **キャパシティモード**: **「プロビジョニング済み (Provisioned)」** を選択します (※要件に従いオンデマンドではなくこちらを選択)。
   - 必要に応じて読み込み/書き込みキャパシティユニットを設定します (初期は最小値の 1 でも可)。
6. 「テーブルの作成」をクリックします。

---

## 4. Lambda 関数の作成と設定

Bot のロジックを実行する Lambda 関数を作成します。

### 4.1 関数の作成
1. サービス検索で「Lambda」を検索し、ダッシュボードへ移動します。
2. 「関数の作成」をクリックします。
3. 「一から作成」を選択します。
4. **関数名**: 任意の名前 (例: `LineBotFunction`) を入力します。
5. **ランタイム**: 使用する言語 (例: `Python 3.9` や `Node.js 18.x`) を選択します。
6. 「関数の作成」をクリックします。

### 4.2 関数 URL (Function URL) の設定
API Gateway の代わりに Function URL を使用して、LINE プラットフォームからの Webhook を受け取ります。

1. 作成した関数の概要画面で「設定」タブ → 左メニューの「関数 URL」を選択します。
2. 「関数 URL を作成」をクリックします。
3. **認証タイプ**: `NONE` を選択します (LINE プラットフォームからのアクセスを許可するため)。
   - ※セキュリティのため、コード内で LINE からの署名検証ロジックを必ず実装してください。
4. 「保存」をクリックします。発行された「関数 URL」を控えておきます。

### 4.3 ログ設定 (CloudWatch Logs)
ログの保存期間を有限に設定し、ストレージコストを抑えます。

1. 「設定」タブ → 「モニタリングと運用ツール」→「ログ」の横の「編集」をクリック、または CloudWatch コンソールへ移動します。
2. 該当するロググループ (通常は `/aws/lambda/<関数名>`) を選択します。
3. 「保持設定の編集」をクリックします。
4. **保持期間**: 適切な期間 (例: 「1 週間」や「30 日」) を選択します。
5. 「保存」をクリックします。

---

## 5. デプロイ手順

ローカルで開発したコードを Lambda にデプロイします。

### 5.1 コードの準備
必要なライブラリ (LINE Messaging API SDK など) をインストールし、コードと一緒に zip 化します。

**例 (Python の場合):**
```bash
# プロジェクトディレクトリを作成
mkdir line-bot
cd line-bot

# ライブラリを現在のディレクトリにインストール
pip install line-bot-sdk -t .

# 用意した lambda_function.py をこのディレクトリにコピー (または新規作成して編集)
cp ../lambda_function.py .

# zip ファイルを作成
zip -r function.zip .
```

### 5.2 アップロード
1. Lambda コンソールの「コード」タブを開きます。
2. 「アップロード元」ボタン → 「.zip ファイル」を選択します。
3. 作成した `function.zip` をアップロードし、「保存」をクリックします。

---

## 6. LINE Developers コンソールとの連携

1. [LINE Developers コンソール](https://developers.line.biz/console/) にログインし、Messaging API チャネルを作成します。
2. **Webhook URL** の設定欄に、Lambda で発行した **関数 URL** を入力します。
3. 「検証」ボタンをクリックして接続確認を行います (※コードが正しく署名検証を実装していないとエラーになる場合がありますが、疎通確認としては重要です)。
4. 「Webhook の利用」をオンにします。

以上で、AWS 上での LINE Bot の基盤構築とデプロイ準備は完了です。
